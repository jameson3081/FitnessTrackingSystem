<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('./partials/title.ejs') %>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">

    <!--FONTS-->
    <link href='https://fonts.googleapis.com/css?family=Inter' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--CSS FILE-->
    <link rel="stylesheet" href="fprofile.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <!--BOOTSTRAP REFERENCE-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>


<body style = "background-color: #E5DDCB;">
    
    <!--- NAVIGATION BAR --->

        <div class="navbar">
                <p><a href = "/"><img src="img/logo.png" width="460" height="90" ></p></a>
                    <ul>
                        <strong>
                            <a href="/"><li>HOME</li></a>
                            <a href="/fprofile"><li style="color: #af241a">FITNESS PROFILE</li></a>
                            <a href="/flog"><li>FITNESS LOG</li></a>
                            <a href="/signIn"><li>ACCOUNT</li></a>
                        </strong>

                    </ul>
        </div>



    <!--Main Page Content-->

        <div id = "fprofile_box" class="wrapper">
            <h1 id = "fprofile_title">MY SMART FITNESS PROFILE</h1>
            <form id="fprofile-form">
                <label for="classNumber" id="classnumLabel">Class number:</label>
                <br>
                <input type="number" id = "classNumber" name = "classNumber" class = "centerAligned" placeholder=" - ENTER CLASS NUM -">
                <br>
                

                <label for="fullname" class = "fprofile_labels">Full Name:</label>
                <input type="text" id="fullname" name="fullname" class="centerAligned" placeholder="- ENTER NAME -" value="<%= fprofile && fprofile.fullname || '' %>">


                <label for="notes" id="notesLabel">NOTES</label>
                <br>
                
                <div id="notes">
                    <p id="notesBody">
                    1. All White Fields are to be filled out.
                    <br>
                    2. All Fields in Yellow are Drop Down 
                    Buttons. Choose your answer from the menu.
                    <br>
                    3. There are indicators beside the fields 
                    that indicate if your inputs are either correct or incorrect.
                    These are automatically computed.
                    <br>
                    4. The goal is to get correct answers to 
                    those fields with indicators. Once the 
                    indicators show that you are correct, 
                    it means you will get full points for 
                    part 1 of the activity.
                    <br>
                    5. If your "Goal" is to "Maintain Weight",
                    please choose 0 in the "How much in Kg?" field.
                    <br>
                    6. Please make sure that you answer all the fields.

                </p>
                </div>
                <br>

                <label for="yearANDsection" class = "fprofile_labels">Yr/Section:</label>
                <input type="text" id = "yearANDsection" name = "yearANDsection" class = "centerAligned" placeholder=" - ENTER YR/SEC -">
                <br>

                <label for="PEsched" class = "fprofile_labels">PE Schedule:</label>
                <input type="text" id = "PEsched" name = "PEsched" class = "centerAligned" placeholder=" - ENTER SCHED -" >
                <br>

                <br>
                <br>
                <br>
                <div id = "sexToBMR">
                <label for="sex" class = "fprofile_labels">Sex:   </label>
                <select name="sex" id="sex-options" class="combobox">
                    <% if (fprofile && fprofile.sex) { %>
                      <option value="<%= fprofile.sex %>" selected><%= fprofile.sex %></option>
                    <% } else { %>
                      <option value="Male">Male</option>
                      <option value="Female">Female</option>
                    <% } %>
                  </select>
                <label for="BMI" class = "fprofile_labels" id = "bmilabel">BMI: </label>
                <input type="text" id = "bmi" name = "BMI" value="<%= fprofile && fprofile.bmi || '' %>">
                <span id="bmiCheck" class="check">Correct ✅ </span>    
    
                <br>
                <label for="Age" class = "fprofile_labels">Age: </label>
                <input type="text" id = "age" name = "Age" value="<%= fprofile && fprofile.age || '' %>">

                <label for="BMR" class = "fprofile_labels" id="bmrlabel">BMR: </label>
                <input type="text" id = "bmr" name = "BMR" value="<%= fprofile && fprofile.bmr || '' %>">
                <span id="bmrCheck" class="check">Correct ✅ </span>  
                <br>
                </div>

                
                <label for="Height" class = "fprofile_labels" id = "heightlabel">Height (cm): </label>
                <input type="text" id = "Height" class = "heightweight" name = "Height" value="<%= fprofile && fprofile.height || '' %>">
                    
                <label for="actLevel" class = "fprofile_labels" id = actLevelLabel>Activity level:</label>
                <select name="actLevel" id="actLevel" class="combobox">
                    <% if (fprofile && fprofile.act) { %>
                      <option value="<%= fprofile.act %>" selected><%= fprofile.act %></option>
                      <option value="No exercise">Little to no exercise</option>
                      <option value="Light">Lightly exercise (1-3 days a week)</option>
                      <option value="Medium">Medium exercise (3-5 days a week)</option>
                      <option value="Very_active">Hard exercise (6-7 days a week)</option>
                      <option value="Extra_active">Intense exercise/sports</option>
                    <% } else { %>
                      <option value="" selected disabled>Select activity level</option>
                      <option value="No exercise">Little to no exercise</option>
                      <option value="Light">Lightly exercise (1-3 days a week)</option>
                      <option value="Medium">Medium exercise (3-5 days a week)</option>
                      <option value="Very_active">Hard exercise (6-7 days a week)</option>
                      <option value="Extra_active">Intense exercise/sports</option>
                    <% } %>
                  </select>
                <br>
                
                <label for="Weight" class = "fprofile_labels" id = "weightlabel">Weight (kg): </label>
                <input type="text" id = "weight" class = "heightweight" name = "weight" value="<%= fprofile && fprofile.weight || '' %>">
                <br>
                
                
            
                <span class = "fprofile_labels">Translation: </span>
                <span id="bmiCheck" class="check">Correct ✅ </span>  

                <br>
                <br>
                <br>
                <br>
                
                <label for="goal" class = "fprofile_labels" id="goal_label">Goal: </label>
                <select name="goal" id="goal" class="combobox">
                    <option value="Maintain weight" <% if (fprofile && fprofile.goal === "Maintain weight") { %> selected <% } %>>Maintain weight</option>
                    <option value="Lose weight" <% if (fprofile && fprofile.goal === "Lose weight") { %> selected <% } %>>Lose weight</option>
                    <option value="Gain weight" <% if (fprofile && fprofile.goal === "Gain weight") { %> selected <% } %>>Gain weight</option>
                </select>

                <label for="howMuch" class = "fprofile_labels" id = "kglabel">How much in kg?: </label>
                <select name="howMuch" id="howMuch" class="combobox">
                    <% if (fprofile && fprofile.kg) { %>
                        <option value="<%= fprofile.kg %>" selected><%= fprofile.kg %></option>
                      <% } %>                    
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                </select>

                <br>

                <label for="timeFrame" class = "fprofile_labels">Time frame (days): </label>
                <select name="timeFrame" id="timeFrame" class="combobox">
                    <% if (fprofile && fprofile.time) { %>
                        <option value="<%= fprofile.time %>" selected><%= fprofile.time %></option>
                      <% } %>
                    <option value="30 days">30</option>
                    <option value="60 days">60</option>
                    <option value="90 days">90</option>
                  
                </select>
                <br>
                <label for="goalKcal" class = "fprofile_labels">Goal kCal intake: </label>
                <input type="text" id="goalKcal" name="goalKcal" value="<%= fprofile && fprofile.goalKcal ? fprofile.goalKcal : '' %>">
                <span id="goalCheck" class="check">Correct ✅ </span>  
                <br>

                <p class="fprofile_labels" id="goal_result">This is a good goal! 🙂</p>

               
                    <button type="submit" id ="saveButton" class="button"> </button>

                    
                
                </form>


                
        </div>
    
      



    <!--BOOTSTRAP REFERENCE-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
        let allInp = document.querySelectorAll("input")
        let allSel = document.querySelectorAll("select")

    //Make all inputs readonly, when not logged in
    if (!localStorage.getItem("TOKEN")) {
        for (let i = 0; i < allInp.length; i++) {
        allInp[i].setAttribute('readonly', true)                                                       
        }

    for (let i = 0; i < allSel.length; i++) {
        allSel[i].setAttribute('disabled', true)
        }
    } else {

    }

    const form = document.getElementById('fprofile-form')
    form.addEventListener('submit', sendProfileData)
  
    async function sendProfileData(event) {
        event.preventDefault()
        const fullname = document.getElementById('fullname').value
        const age = document.getElementById('age').value
        const height = document.getElementById('Height').value
        const weight = document.getElementById('weight').value
        const bmi = document.getElementById('bmi').value
        const bmr = document.getElementById('bmr').value

        let sexOptions = document.getElementById("sex-options");
        let sex = sexOptions.value;

        let actOptions = document.getElementById("actLevel");
        let act = actOptions.value;

        let goalOptions = document.getElementById("goal");
        let goal = goalOptions.value;

        let timeOptions = document.getElementById("timeFrame");
        let time = timeOptions.value;


        let inKG = document.getElementById("howMuch");
        let kg = inKG.value

        const goalKcal = document.getElementById('goalKcal').value


        const lstoken = localStorage.getItem("TOKEN")

        function parseJwt (token) { 
        var base64Url = token.split('.')[1];
        var base64 = decodeURIComponent(atob(base64Url).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(base64);
}

    let decodedID = parseJwt(localStorage.getItem("TOKEN")).id
    
        const result = await fetch('/fprofile', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            fullname,
            sex,
            age,
            height,
            weight,
            bmi,
            bmr,
            act,
            goal,
            time,
            kg,
            goalKcal,
            decodedID
          })
        }).then((res) => res.json())
        if (result.status === 'ok') {
          alert('Profile info submitted')
          console.log(result.data)
        } else {
          alert(JSON.stringify(result.error))
        }
      }


     
      function parseJwt (token) { 
        var base64Url = token.split('.')[1];
        var base64 = decodeURIComponent(atob(base64Url).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

        return JSON.parse(base64);
    }


 
//CHANGES URL

const token = localStorage.getItem("TOKEN");
const { id } = parseJwt(token);
const urlParams = new URLSearchParams(window.location.search);
const decodedID = urlParams.get('decodedID');

if (decodedID) {
  // Fetch data using decodedID
  fetch(`/fprofile?decodedID=${decodedID}`)
    .then(response => response.json())
    .then(data => {
      if (data.fprofile) {
        console.log(data.fprofile.fullname);
      } else {
        console.log("I am else");
      }
    })
    .catch(error => console.error(error));
} else {
  // Redirect to the same URL with decodedID query string appended
  window.location.href = `/fprofile?decodedID=${id}`;
}
  

    </script>
</body>
</html>
